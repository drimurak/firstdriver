# Minimal Linux Block Device Driver (RAMDisk)

Простой учебный драйвер блочного устройства для современных ядер Linux (тестировалось на **6.17+**). Проект создавался для изучения `blk-mq` API и того, как подсистема блоков обрабатывает `bio`.

## Особенности

* Работает на ядрах 6.x (учитывает новые правила инициализации `queue_limits`).
* Использует `submit_bio` для прямой обработки запросов.
* Минимальный оверхед: вся память выделяется через `vmalloc`.
* В комплекте скрипты для быстрого развертывания в **QEMU + BusyBox**.

## Почему этот проект существует?

Если вы пробовали писать RAM-диск по старым туториалам, вы наверняка ловили `add_disk failed with -22`. В новых ядрах (6.14+) API стало гораздо строже к лимитам очереди. Этот драйвер показывает, как правильно проинициализировать устройство, чтобы ядро его не уничтожало.

## Как запустить

### 1. Сборка модуля

```bash
make

```

### 2. Тестирование в изолированной среде

Я использую QEMU, чтобы не «уронить» основную систему при отладке.
Скрипт `run.sh` собирает минимальный `initramfs`, закидывает туда модуль и запускает ядро.

```bash
cd qemu_test
./run.sh

```


### 3. Проверка внутри QEMU

<img width="623" height="165" alt="image" src="https://github.com/user-attachments/assets/11443fd3-593a-47cc-9d16-712a5497b73a" />


```bash
# Проверяем, что диск появился
cat /proc/partitions

# Тестируем запись/чтение
echo "Data integrity check" > /dev/my_ramdisk
head -c 20 /dev/my_ramdisk

```
<img width="491" height="119" alt="image" src="https://github.com/user-attachments/assets/49426093-25ee-4605-910c-eba7bd7118c7" />


## Что внутри?

* **Kernel API**: `blk_alloc_disk`, `blk_set_stacking_limits`, `add_disk`.
* **Memory**: Динамическое выделение через `vmalloc`.
* **I/O**: Посекторная обработка через итератор `bio_for_each_segment`.

## Что можно улучшить (TODO)

* [ ] Перейти на `blk-mq` для поддержки многопоточности.
* [ ] Добавить поддержку разделов (сейчас `GENHD_FL_NO_PART`).
* [ ] Реализовать простую симуляцию задержек (IO Latency) для тестов производительности.

---
